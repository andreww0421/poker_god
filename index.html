<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#0f172a">
    <title>Poker God Pro</title>
    
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" href="./icon.png">
    <link rel="apple-touch-icon" href="./icon.png">
    
    <style>
        :root {
            --bg-dark: #0f172a;
            --bg-panel: rgba(30, 41, 59, 0.7);
            --accent: #10b981; /* Emerald Green */
            --accent-glow: rgba(16, 185, 129, 0.2);
            --danger: #ef4444;
            --warning: #f59e0b;
            --text-main: #f1f5f9;
            --text-muted: #94a3b8;
            --border: rgba(255,255,255,0.1);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            background-color: var(--bg-dark);
            background-image: radial-gradient(circle at 10% 20%, rgba(16, 185, 129, 0.05) 0%, transparent 20%);
            color: var(--text-main);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            margin: 0; padding: 0;
            padding-bottom: 90px; /* Space for bottom nav */
            min-height: 100vh;
        }

        /* Header */
        header {
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(10px);
            padding: 15px 20px;
            position: sticky; top: 0; z-index: 50;
            border-bottom: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: center;
        }
        h1 { margin: 0; font-size: 1.2rem; font-weight: 800; letter-spacing: 0.5px; background: linear-gradient(to right, #10b981, #3b82f6); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }

        /* Container & Grid */
        .container { max-width: 600px; margin: 0 auto; padding: 15px; }
        
        /* Cards & Panels */
        .card-panel {
            background: var(--bg-panel);
            backdrop-filter: blur(12px);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        }

        /* Inputs */
        .input-group { margin-bottom: 12px; }
        label { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; color: var(--text-muted); margin-bottom: 6px; display: block; }
        select, input, textarea {
            width: 100%; background: rgba(0,0,0,0.3); border: 1px solid var(--border);
            color: white; padding: 12px; border-radius: 8px; font-size: 1rem; outline: none; transition: border 0.2s;
        }
        select:focus, input:focus, textarea:focus { border-color: var(--accent); }

        /* Poker Cards Visuals */
        .hand-display { display: flex; gap: 10px; justify-content: center; margin: 15px 0; }
        .poker-card {
            width: 50px; height: 70px; background: #e2e8f0; border-radius: 6px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            font-weight: bold; font-size: 1.2rem; cursor: pointer; position: relative;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2); transition: transform 0.1s;
        }
        .poker-card:active { transform: scale(0.95); }
        .poker-card.empty { background: rgba(255,255,255,0.05); border: 2px dashed var(--text-muted); color: var(--text-muted); box-shadow: none; }
        .poker-card.selected { border: 2px solid var(--accent); background: white; }
        
        /* Suit Colors */
        .suit-s { color: #1e293b; }
        .suit-h { color: #ef4444; }
        .suit-c { color: #10b981; }
        .suit-d { color: #3b82f6; }

        /* Bottom Nav */
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(10px);
            border-top: 1px solid var(--border);
            display: flex; justify-content: space-around;
            padding: 12px 0 25px 0; z-index: 100; /* Extra padding for iPhone X+ home bar */
        }
        .nav-item {
            color: var(--text-muted); text-align: center; font-size: 0.7rem; cursor: pointer;
            flex: 1; opacity: 0.7; transition: 0.2s;
        }
        .nav-item.active { color: var(--accent); opacity: 1; transform: translateY(-2px); }
        .nav-icon { font-size: 1.4rem; display: block; margin-bottom: 2px; }

        /* Sections (Tabs) */
        .tab-content { display: none; animation: fadeIn 0.3s ease; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* 13x13 Grid */
        .chart-container {
            display: grid; grid-template-columns: repeat(13, 1fr); gap: 1px;
            background: #000; padding: 1px; border-radius: 4px; overflow: hidden;
        }
        .chart-cell {
            aspect-ratio: 1; font-size: 0.5rem; display: flex; align-items: center; justify-content: center;
            background: #2d3748; color: #718096; cursor: default;
        }
        .chart-cell.bg-raise { background: var(--danger); color: white; }
        .chart-cell.bg-call { background: var(--warning); color: black; }
        .chart-cell.active { border: 2px solid white; z-index: 10; }

        /* Bankroll Specific */
        .profit-pos { color: var(--accent); }
        .profit-neg { color: var(--danger); }
        
        .history-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px 0; border-bottom: 1px solid var(--border);
        }
        .history-item:last-child { border-bottom: none; }
        .history-date { font-size: 0.75rem; color: var(--text-muted); }
        .history-note { font-size: 0.85rem; color: #e2e8f0; }
        .del-btn { color: var(--text-muted); font-size: 0.8rem; padding: 5px; cursor: pointer; }

        .btn-calc {
            width: 100%; padding: 14px; background: var(--accent); color: #000;
            border: none; border-radius: 8px; font-weight: bold; font-size: 1rem; cursor: pointer;
            box-shadow: 0 4px 15px var(--accent-glow);
        }

        /* Canvas Graph */
        canvas { width: 100%; height: 200px; display: block; }

        /* Modal */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 200; justify-content: center; align-items: center; }
        .modal-content { background: #1e293b; padding: 20px; border-radius: 16px; width: 90%; max-width: 350px; border: 1px solid var(--border); }
        .suit-row { display: flex; gap: 5px; margin-bottom: 8px; }
        .rank-btn { flex: 1; padding: 10px 0; background: #334155; border: none; color: white; border-radius: 4px; font-weight: bold; }
    </style>
</head>
<body>

<header>
    <h1>Poker God <span style="font-size:0.5em; opacity:0.8; color:white; background:none;">PRO</span></h1>
    <div id="connectionStatus" style="width:8px; height:8px; background:var(--accent); border-radius:50%;"></div>
</header>

<div class="container">
    
    <div id="tab-ranges" class="tab-content active">
        <div class="card-panel">
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <select id="gameMode" onchange="updateRanges()"><option value="MTT">Èå¶Ê®ôË≥Ω (MTT)</option><option value="Cash">ÁèæÈáëÊ°å (Cash)</option></select>
                <select id="playerCount" onchange="updateRanges()">
                    <option value="10">10‰∫∫ (Full Ring)</option>
                    <option value="9" selected>9‰∫∫ (Full Ring)</option>
                    <option value="8">8‰∫∫</option>
                    <option value="7">7‰∫∫</option>
                    <option value="6">6‰∫∫ (6-Max)</option>
                    <option value="5">5‰∫∫</option>
                    <option value="4">4‰∫∫</option>
                    <option value="3">3‰∫∫</option>
                    <option value="2">2‰∫∫ (Heads Up)</option>
                </select>
                <select id="heroPosition" onchange="updateRanges()">
                    <option value="BTN">BTN</option><option value="CO">CO</option><option value="MP">MP</option><option value="EP">EP/UTG</option><option value="SB">SB</option><option value="BB">BB</option>
                </select>
                <input type="number" id="stackDepth" value="100" placeholder="BB" onchange="updateRanges()">
            </div>
        </div>

        <div class="card-panel">
            <label>13x13 Ëµ∑ÊâãÁâåÁÜ±ÂäõÂúñ (Preflop Ranges)</label>
            <div class="chart-container" id="rangeGrid"></div>
            <div style="display:flex; justify-content:center; gap:15px; margin-top:10px; font-size:0.75rem; color:var(--text-muted);">
                <span style="color:var(--danger)">‚óè Raise/All-in</span>
                <span style="color:var(--warning)">‚óè Call/Mix</span>
                <span style="color:#718096">‚óè Fold</span>
            </div>
        </div>
    </div>

    <div id="tab-odds" class="tab-content">
        <div class="card-panel">
            <label>Â∫ïÊ±†Ë≥†ÁéáË®àÁÆóÊ©ü (Pot Odds)</label>
            <div class="input-group">
                <label>Áï∂ÂâçÂ∫ïÊ±†Â§ßÂ∞è (Current Pot)</label>
                <input type="number" id="potSize" placeholder="‰æãÂ¶Ç: 1000">
            </div>
            <div class="input-group">
                <label>Â∞çÊñπ‰∏ãÊ≥® / Ë∑üÊ≥®ÈáëÈ°ç (Call Amount)</label>
                <input type="number" id="betSize" placeholder="‰æãÂ¶Ç: 500">
            </div>
            <button class="btn-calc" onclick="calcPotOdds()">Ë®àÁÆóË≥†Áéá (Calculate)</button>

            <div class="result-box" id="oddsResult" style="text-align:center; margin-top:15px; display:none;">
                <div style="color:var(--text-muted); font-size:0.8rem;">ÊâÄÈúÄÂãùÁéá (Required Equity)</div>
                <div style="font-size:1.8rem; font-weight:bold; color:var(--accent);" id="reqEquity">--%</div>
                <div style="margin-top:5px; color:white;" id="oddsRatio">-- : 1</div>
            </div>
        </div>
    </div>

    <div id="tab-postflop" class="tab-content">
        <div class="card-panel">
            <label>ÊâãÁâå (My Hand)</label>
            <div class="hand-display">
                <div class="poker-card empty" id="card_h1" onclick="sel('h1')">+</div>
                <div class="poker-card empty" id="card_h2" onclick="sel('h2')">+</div>
            </div>
            <label style="margin-top:15px;">ÂÖ¨ÂÖ±Áâå (Board)</label>
            <div class="hand-display" style="gap:5px;">
                <div class="poker-card empty" style="width:40px; height:60px; font-size:1rem;" id="card_b1" onclick="sel('b1')"></div>
                <div class="poker-card empty" style="width:40px; height:60px; font-size:1rem;" id="card_b2" onclick="sel('b2')"></div>
                <div class="poker-card empty" style="width:40px; height:60px; font-size:1rem;" id="card_b3" onclick="sel('b3')"></div>
                <div class="poker-card empty" style="width:40px; height:60px; font-size:1rem;" id="card_b4" onclick="sel('b4')"></div>
            </div>
            <button class="btn-calc" onclick="calcPostflop()">ÂàÜÊûêÂãùÁéá (Analyze)</button>
            <div id="postflopResult" style="text-align:center; margin-top:15px; display:none;">
                <div style="color:white; font-size:1.5rem;" id="outsVal">0 Outs</div>
                <div style="color:var(--text-muted); font-size:0.85rem;" id="drawDesc"></div>
            </div>
        </div>
    </div>

    <div id="tab-bankroll" class="tab-content">
        <div class="card-panel">
            <label>Ë≥áÈáëÁ¥ØÁ©çÁ∑öÂúñ (Profit Graph)</label>
            <div style="position:relative; width:100%; height:200px; border-bottom:1px solid #333; margin-bottom:10px;">
                <canvas id="profitChart" width="300" height="200"></canvas>
            </div>
            <div style="display:flex; justify-content:space-between; font-size:0.9rem;">
                <span id="totalProfitLabel">Total: $0</span>
                <span style="color:var(--text-muted);" id="totalGamesLabel">Games: 0</span>
            </div>
        </div>

        <div class="card-panel">
            <label>Êñ∞Â¢ûÊà∞Á∏æ (Add Session)</label>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:10px;">
                <input type="number" id="brAmount" placeholder="ÊêçÁõäÈáëÈ°ç (+/-)">
                <select id="brType"><option value="Cash">Cash Game</option><option value="MTT">MTT</option></select>
            </div>
            <input type="text" id="brNote" placeholder="ÂÇôË®ª (Âú∞Èªû/Á¥öÂà•)..." style="margin-bottom:10px;">
            <button class="btn-calc" onclick="addBankroll()">ÂÑ≤Â≠òÁ¥ÄÈåÑ (Save)</button>
        </div>

        <div class="card-panel">
            <label>ËøëÊúüÁ¥ÄÈåÑ (History)</label>
            <div id="historyList"></div>
        </div>
    </div>

</div>

<div class="bottom-nav">
    <div class="nav-item active" onclick="switchTab('ranges', this)">
        <span class="nav-icon">üìä</span> Ranges
    </div>
    <div class="nav-item" onclick="switchTab('odds', this)">
        <span class="nav-icon">üßÆ</span> Odds
    </div>
    <div class="nav-item" onclick="switchTab('postflop', this)">
        <span class="nav-icon">‚ô†Ô∏è</span> Postflop
    </div>
    <div class="nav-item" onclick="switchTab('bankroll', this)">
        <span class="nav-icon">üí∞</span> Bankroll
    </div>
</div>

<div class="modal" id="cardModal">
    <div class="modal-content">
        <h3 style="margin:0 0 15px 0; color:white;">Select Card</h3>
        <div id="suit-spades" class="suit-row"></div>
        <div id="suit-hearts" class="suit-row"></div>
        <div id="suit-clubs" class="suit-row"></div>
        <div id="suit-diamonds" class="suit-row"></div>
        <button onclick="closeSel()" style="width:100%; margin-top:10px; padding:10px; background:rgba(255,255,255,0.1); border:none; color:white; border-radius:4px;">Cancel</button>
    </div>
</div>

<script>
    // --- SERVICE WORKER ---
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => { navigator.serviceWorker.register('./sw.js').catch(e=>console.log(e)); });
    }

    // --- APP STATE ---
    const state = { h1: null, h2: null, b1:null, b2:null, b3:null, b4:null };
    let curSel = null;
    const ranks = ['A','K','Q','J','T','9','8','7','6','5','4','3','2'];
    let bankrollData = JSON.parse(localStorage.getItem('pokerBankroll') || '[]');

    window.onload = () => {
        genGrid(); genSelUI(); updateRanges(); renderBankroll();
    };

    function switchTab(tabId, navEl) {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
        document.getElementById('tab-' + tabId).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        navEl.classList.add('active');
        if(tabId === 'bankroll') drawChart(); // Re-draw chart when visible
    }

    // --- LOGIC: RANGES ---
    function genGrid() {
        const c = document.getElementById('rangeGrid'); c.innerHTML = '';
        for(let i=0; i<13; i++) for(let j=0; j<13; j++) {
            let div = document.createElement('div'); div.className = 'chart-cell';
            let txt = i===j ? ranks[i]+ranks[j] : (i<j ? ranks[i]+ranks[j]+'s' : ranks[j]+ranks[i]+'o');
            div.innerText = txt; div.dataset.h = txt; c.appendChild(div);
        }
    }

    function updateRanges() {
        const pos = document.getElementById('heroPosition').value;
        const stack = parseInt(document.getElementById('stackDepth').value);
        const players = parseInt(document.getElementById('playerCount').value);
        
        // Strictness Score Calculation
        let score = 0; 
        if(pos==='BTN') score=5; else if(pos==='CO') score=3; else if(pos==='MP') score=1;
        if(document.getElementById('gameMode').value === 'MTT') score += 1;
        
        // Player count adjustment: Fewer players = Looser play
        if(players <= 6) score += 1;
        if(players === 2) score += 4; // Heads up is very loose

        if(stack < 15) score = -10; // Push/Fold mode

        document.querySelectorAll('.chart-cell').forEach(cell => {
            let h = cell.dataset.h;
            let act = 0;
            if(stack < 15) {
                if(h.includes('A') || h[0]===h[1] || (h.includes('K') && h.includes('s'))) act=2;
            } else {
                if(h[0]===h[1]) act = (ranks.indexOf(h[0]) < 8 + score) ? 2 : 0;
                else if(h.includes('s')) act = (ranks.indexOf(h[0]) < 5 + score && ranks.indexOf(h[1]) < 9 + score) ? 2 : 0;
                else if(h.includes('o')) act = (ranks.indexOf(h[0]) < 3 + score && ranks.indexOf(h[1]) < 5) ? 2 : 0;
                if(act===0 && score > 3 && h.includes('s')) act=1; 
            }
            cell.className = 'chart-cell ' + (act===2 ? 'bg-raise' : (act===1 ? 'bg-call' : ''));
        });
    }

    // --- LOGIC: ODDS & POSTFLOP ---
    function calcPotOdds() {
        let pot = parseFloat(document.getElementById('potSize').value);
        let call = parseFloat(document.getElementById('betSize').value);
        if(!pot || !call) return;
        let req = (call / (pot + call * 2)) * 100;
        document.getElementById('oddsResult').style.display='block';
        document.getElementById('reqEquity').innerText = req.toFixed(1) + '%';
        document.getElementById('oddsRatio').innerText = ((pot+call)/call).toFixed(1) + ' : 1';
    }

    function calcPostflop() {
        if(!state.h1 || !state.h2 || !state.b1 || !state.b2 || !state.b3) return;
        let suits = {'s':0, 'h':0, 'c':0, 'd':0};
        [state.h1, state.h2, state.b1, state.b2, state.b3].forEach(c => suits[c.suit.id]++);
        let outs = 0; let desc = [];
        for(let s in suits) if(suits[s]===4) { outs+=9; desc.push("Flush Draw"); }
        if(state.h1.rank === state.h2.rank) { outs+=2; desc.push("Set Mining"); }
        else { outs+=6; desc.push("Overcards"); }
        if(outs>15) outs=15;
        document.getElementById('postflopResult').style.display='block';
        document.getElementById('outsVal').innerText = outs + ' Outs (~' + (outs*4) + '%)';
        document.getElementById('drawDesc').innerText = desc.join(', ') || "High Card";
    }

    // --- LOGIC: BANKROLL & CHART ---
    function addBankroll() {
        let amt = parseFloat(document.getElementById('brAmount').value);
        let type = document.getElementById('brType').value;
        let note = document.getElementById('brNote').value;
        if(isNaN(amt)) return;

        bankrollData.push({ id: Date.now(), date: new Date().toLocaleDateString(), amt, type, note });
        localStorage.setItem('pokerBankroll', JSON.stringify(bankrollData));
        
        document.getElementById('brAmount').value = '';
        document.getElementById('brNote').value = '';
        renderBankroll();
    }

    function deleteEntry(id) {
        if(!confirm("Á¢∫ÂÆöÂà™Èô§Ê≠§Á¥ÄÈåÑ?")) return;
        bankrollData = bankrollData.filter(i => i.id !== id);
        localStorage.setItem('pokerBankroll', JSON.stringify(bankrollData));
        renderBankroll();
    }

    function renderBankroll() {
        const list = document.getElementById('historyList');
        list.innerHTML = '';
        let total = 0;

        // Render List (Newest first)
        [...bankrollData].reverse().forEach(item => {
            total += item.amt;
            let div = document.createElement('div');
            div.className = 'history-item';
            div.innerHTML = `
                <div>
                    <div style="font-weight:bold;" class="${item.amt >= 0 ? 'profit-pos' : 'profit-neg'}">
                        ${item.amt >= 0 ? '+' : ''}${item.amt} <span style="font-size:0.7em; color:#888;">(${item.type})</span>
                    </div>
                    <div class="history-note">${item.note || '-'}</div>
                </div>
                <div style="text-align:right;">
                    <div class="history-date">${item.date}</div>
                    <div class="del-btn" onclick="deleteEntry(${item.id})">‚úï</div>
                </div>
            `;
            list.appendChild(div);
        });

        // Update Totals
        // Re-calc total strictly for display sum
        let sum = bankrollData.reduce((acc, curr) => acc + curr.amt, 0);
        document.getElementById('totalProfitLabel').innerHTML = `Total: <span class="${sum>=0?'profit-pos':'profit-neg'}">$${sum}</span>`;
        document.getElementById('totalGamesLabel').innerText = `Games: ${bankrollData.length}`;

        drawChart();
    }

    function drawChart() {
        const cvs = document.getElementById('profitChart');
        const ctx = cvs.getContext('2d');
        const w = cvs.width, h = cvs.height;
        ctx.clearRect(0, 0, w, h);

        if(bankrollData.length === 0) {
            ctx.fillStyle = '#444'; ctx.font = '12px Arial';
            ctx.fillText("Â∞öÁÑ°Êï∏Êìö (No Data)", w/2 - 40, h/2);
            return;
        }

        // Prepare Data Points (Cumulative)
        let dataPoints = [];
        let runningTotal = 0;
        dataPoints.push(0); // Start at 0
        bankrollData.forEach(d => {
            runningTotal += d.amt;
            dataPoints.push(runningTotal);
        });

        // Find min/max for scaling
        let maxVal = Math.max(...dataPoints);
        let minVal = Math.min(...dataPoints);
        if(maxVal === minVal) { maxVal += 100; minVal -= 100; } // avoid flat line issue
        let padding = 20;

        // Helper to map values to pixels
        const mapX = (i) => padding + (i / (dataPoints.length - 1)) * (w - padding * 2);
        const mapY = (val) => h - (padding + ((val - minVal) / (maxVal - minVal)) * (h - padding * 2));

        // Draw Zero Line
        let zeroY = mapY(0);
        if(zeroY >= 0 && zeroY <= h) {
            ctx.beginPath(); ctx.strokeStyle = '#333'; ctx.lineWidth = 1;
            ctx.moveTo(padding, zeroY); ctx.lineTo(w-padding, zeroY); ctx.stroke();
        }

        // Draw Line Path
        ctx.beginPath();
        ctx.strokeStyle = '#10b981'; ctx.lineWidth = 2;
        dataPoints.forEach((val, i) => {
            let x = mapX(i);
            let y = mapY(val);
            if(i===0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
        });
        ctx.stroke();

        // Draw Dots
        dataPoints.forEach((val, i) => {
            let x = mapX(i);
            let y = mapY(val);
            ctx.beginPath();
            ctx.fillStyle = val >= 0 ? '#10b981' : '#ef4444';
            ctx.arc(x, y, 3, 0, Math.PI * 2);
            ctx.fill();
        });
    }

    // --- HELPER UI ---
    function genSelUI() {
        const suits = [{id:'s',s:'‚ô†',c:'suit-s'},{id:'h',s:'‚ô•',c:'suit-h'},{id:'c',s:'‚ô£',c:'suit-c'},{id:'d',s:'‚ô¶',c:'suit-d'}];
        suits.forEach(s => {
            let row = document.getElementById('suit-'+(s.id==='s'?'spades':s.id==='h'?'hearts':s.id==='c'?'clubs':'diamonds'));
            ['A','K','Q','J','T','9','8'].forEach(r => { 
                let b = document.createElement('button'); b.className=`rank-btn ${s.c}`; b.innerText=r+s.s;
                b.onclick=()=>{ setCard(r, s); }; row.appendChild(b);
            });
        });
    }
    function sel(id) { curSel=id; document.getElementById('cardModal').style.display='flex'; }
    function closeSel() { document.getElementById('cardModal').style.display='none'; }
    function setCard(r,s) {
        state[curSel] = {rank:r, suit:s};
        let el = document.getElementById('card_'+curSel);
        el.className = 'poker-card selected';
        el.innerHTML = `<span class="${s.c}">${s.s}</span><span>${r}</span>`;
        closeSel();
    }
</script>
</body>
</html>
